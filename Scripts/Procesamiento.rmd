---
title: "Untitled"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Este cuaderno de código permite la carga y procesamiento de datos del los mapas de suelos de Colombia a escala 1:100.000 del IGAC. El producto final del script es un conjunto de datos con las variables necesarias para hacer cálculos de pedodiversidad.

## Configuración

A continuación se cargan las librería necesarias

```{r confi, include = FALSE}

# Para renderizar el documento
knitr::opts_chunk$set(echo = TRUE)

# Para cargar librerias se verifica pacman
if ("pacman" %in% installed.packages() == FALSE) install.packages("pacman")

# Se cargan las librerias
pacman::p_load(char = c("httr", "googledrive", "jsonlite", "sf", "dplyr", "here", "tidyr", "stringr", "purrr", "SoilTaxonomy", "wesanderson"))

```

## Carga de datos

A continuación se carga un subconjunto de datos para pilotear los análisis. Los datos se solicitan al IGAC via API. El acceso a estos se encuentra en el Hub de ArcGIS, seleccionando el conjunto de datos con Mapserver. [Ejemplo: enlace a datos del Vichada](https://hub.arcgis.com/maps/25fd261fde5c4641b6adfae4e1c4a779/about)

Una vez se abre cualquiera de los enlces para WMS o WFS se puede acceder al total de datos del IGAC desde la [raiz de la URL](https://mapas.igac.gov.co/server/rest/services/agrologia)

Se crean vectores de caracteres para las URL par alos distintos departamentos:

```{r build_url, echo=FALSE}

url_datos <- "https://mapas.igac.gov.co/server/rest/services/agrologia/mapageneraldesuelosdepartamentodevichada/MapServer"

# Se desagrega la url básica en sus componentes
url <- httr::parse_url(url_datos)

layer_id <- "0"

url$path <- paste(url$path, layer_id, "query", sep = "/")

# Se agregan componentes a la URL para solicitud de información
url$query <- list(
    where = "1=1", # para recuperar todos los features
    outFields = "OBJECTID, UCS, PAISAJE, CLIMA, COMPONENTES_TAXONOMICOS, PERFIL, PORCENTAJE", # para recuperar estos campos
    returnGeometry = "true", # retorna geometrias
    f = "geojson"
) # retorna formato geojson

# Se construye la url
url_solicitud <- httr::build_url(url)


print(url_solicitud)

```

Luego se hace una solicitud GET a la API y se verifica la respuesta: Status 200 quiere decir exitoso. Status 503 que el servidor no está disponible, puede ser temporal. 

```{r get_request}
# Para recuperar los datos espaciales se usa la librería sf
respuesta <- httr::GET(url_solicitud)

# Se examina la respuesta
print(respuesta)
```

Una vez se obtiene la respuesta con status 200, se procede a extraer lso datos usando la librería `sf`.

```{r get_data}

# el id aparece en la URL del archivo
archivo_drive <- drive_download(file = as_id("1ltc0txG3RIUVr67lvIwTv_DBO6YVnzP4"), overwrite = TRUE)



```

Se verifica visualmente la carga

